<!doctype html>
<meta charset="utf-8">
<title>Diskografi-konvertering</title>
<h1>Last opp CSV</h1>
<form id="f" method="post" action="/convert" enctype="multipart/form-data">
  <label>Velg CSV-fil: <input type="file" name="csv" accept=".csv" required></label><br><br>
  <label>Velg funksjon:
    <select name="function" required>
      <option value="runMX">runMX</option>
      <option value="runRL">runRL</option>
      <option value="AllNames">AllNames</option>
    </select>
  </label><br><br>
  <button type="submit">Execute</button>
</form>
<script>
  document.getElementById('f').addEventListener('submit', e => {
    // lar nettleseren laste ned svaret som fil
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch(form.action, {
      method: form.method,
      body: formData
    })
    .then(async response => {
      if (!response.ok) throw new Error('Nettverksfeil');
      const blob = await response.blob();

      // Try to extract filename from Content-Disposition header set by FileResponse
      let filename = 'result.csv';
      const cd = response.headers.get('content-disposition');
      if (cd) {
        // Try several patterns: RFC5987 (filename*=), quoted filename, or bare filename
        const rfc5987 = /filename\*=[^']+'[^']*'([^;\n\r]+)/i.exec(cd);
        const quoted = /filename="([^"]+)"/i.exec(cd);
        const bare = /filename=([^;\n\r]+)/i.exec(cd);
        if (rfc5987 && rfc5987[1]) {
          try { filename = decodeURIComponent(rfc5987[1]); } catch(_) { filename = rfc5987[1]; }
        } else if (quoted && quoted[1]) {
          filename = quoted[1];
        } else if (bare && bare[1]) {
          filename = bare[1];
        }
      }

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(error => alert('Noe gikk galt: ' + error.message));
  });
</script>
